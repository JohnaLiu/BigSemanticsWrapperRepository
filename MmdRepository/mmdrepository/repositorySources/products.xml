<meta_metadata_repository name="products" package="ecologylab.semantics.generated.library.products">

	<meta_metadata name="product_review" extends="metadata" schema_org_itemtype="http://schema.org/Review" schema_org_itemprop="reviews">
			<scalar name="rating" scalar_type="String" schema_org_itemprop="reviewRating" />
			<scalar name="content" scalar_type="String" schema_org_itemprop="reviewBody" />
	</meta_metadata>
		
	<meta_metadata name="product" extends="compound_document" parser="xpath" schema_org_itemtype="http://schema.org/Product">
		<scalar name="location" hide="true" />

		<scalar name="price" scalar_type="String" schema_org_itemprop="price" xpath="//span[@itemprop='price']/text()"/>
		<scalar name="model" scalar_type="String" schema_org_itemprop="model" />
		<composite name="image" type="image" hide="true"/>

		<scalar name="reviews_location" scalar_type="ParsedURL" hide="true" />
		<scalar name="overall_rating" scalar_type="String" navigates_to="reviews_location"  schema_org_itemprop="aggregateRating" />

		<collection name="reviews" child_type="product_review" layer="1.0"/>

	  <semantic_actions>
	    <get_field name="image" />
	    <create_and_visualize_img_surrogate>
	      <arg name="metadata" value="image" />
	    </create_and_visualize_img_surrogate>
	  </semantic_actions>
	</meta_metadata>

	<meta_metadata name="amazon_product" extends="product" parser="xpath" user_agent_name="firefox">
		<selector url_regex="http://www.amazon.com/[^/]*/dp/[^/]*" domain="amazon.com" />
		<selector url_regex="http://www.amazon.com/gp/product/[^/]*" domain="amazon.com" />
		
		<example_url url="http://www.amazon.com/Twilight-Saga-Breaking-Two-Disc-Special/dp/B002BWP49C"/>
		<example_url url="http://www.amazon.com/Samsung-UN60D7000-60-Inch-1080p-Silver/dp/B004QFGGTY"/>
		<example_url url="http://www.amazon.com/Deathly-Hallows-Movie-Only-Edition-UltraViolet/dp/B005O30Y5Y" />

		<composite name="department" type="document" xpath="//table[@id='navCatSubnav']//a[@class='navCatA']" >
			<scalar name="title" xpath="."/>
			<scalar name="location" hide="true" xpath="./@href" />
		</composite>
		
		<scalar name="price" xpath="//b[@class='priceLarge']" />
		<scalar name="title" xpath="//span[@id='btAsinTitle']" />
		<scalar name="description" xpath="//div[@class='productDescriptionWrapper']"/>
		
		<composite name="image" xpath="//img[@id='prodImage']" >
			<scalar name="location" xpath="./@src" />
		</composite>

<!-- 		<scalar name="model" xpath="//img[@id='prodImage']/@src" /> -->

		<def_var name="reviews_span" xpath="//span[@ref='dp_top_cm_cr_acr_pop_']" type="node" />
		<scalar name="reviews_location" xpath="//span[@ref='dp_top_cm_cr_acr_pop_']/a/@href" />  
		<scalar name="overall_rating"   context_node="reviews_span" xpath=".//span[1]/@title" />
<!-- 		<scalar name="reviews_location" context_node="reviews_span" xpath="./a/@href" /> does not work :-( -->

		<collection name="reviews" xpath="//div[@class='content']/table/tbody/tr[2]/td[1]/div[position() &lt; last()-1]">
			<scalar name="rating" xpath="./div[2]/span/span[1]/@title" layer="20.0" />
			<scalar name="content" xpath="." layer="10.0" /> <!-- not concise! -->
		</collection>
		
		<composite name="bestseller_list" extends="document" xpath="//li[@id='SalesRank']">
			<scalar name="title" xpath=".//b/a" />
			<scalar name="location" hide="true" xpath="//li[@id='SalesRank']/a/@href" />
			<scalar name="rank" scalar_type="string" xpath="./ul/li/span[@class='zg_hrsr_rank']" />
		</composite>
		
		<collection name="people_also_buy" child_type="amazon_product" xpath="//div[@id='vtpsims']/ul/li">
			<scalar name="location" xpath=".//a/@href" />
			<scalar name="title" xpath=".//a" />
			<scalar name="price" xpath=".//div[@class='price']" />
			<scalar name="overall_rating" xpath=".//span[@class='swSprite s_star_3_0 ']" />
		</collection>
		
		<semantic_actions>
			<reselect_meta_metadata_and_extract name="amazon_item" />
			<if>
				<not_null value="amazon_item" />
				<add_mixin object="amazon_item" mixin="metadata"/>
			</if>
		    <get_field name="image" />
		    <create_and_visualize_img_surrogate>
		      <arg name="metadata" value="image" />
		    </create_and_visualize_img_surrogate>
		</semantic_actions>
	</meta_metadata>
	
	<meta_metadata name="amazon_list" extends="document" parser="xpath" user_agent_name="firefox">
		<selector url_path_tree="http://www.amazon.com/gp/registry" />
		<example_url location="http://www.amazon.com/gp/registry/wishlist/ref=wish_list" />
		
		<collection name="items" child_type="amazon_product" xpath="//td[@class='lineItemMainInfo']">
			<scalar name="title" xpath=".//span[@class='small productTitle']"/>
			<scalar name="location" xpath=".//span[@class='small productTitle']/a/@href"/>
		</collection>
	</meta_metadata>

</meta_metadata_repository>
